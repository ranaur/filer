# Tests for Filer Package

Here are pytest test files for each command. They assume the package is installed in editable mode (`pip install -e .`) and that `pytest` is available.

```
tests/
├── test_new.py
├── test_root.py
├── test_analyse.py
├── test_dir.py
├── test_check.py
└── test_dedup.py
```

---

### `tests/test_new.py`
```python
import os
from filer import db
from filer.commands import new


def test_new_creates_filebase(tmp_path):
    args = type("obj", (), {"name": "testbase"})
    new.run(args)
    base_dir = os.path.expanduser("~/.filer")
    db_path = os.path.join(base_dir, "testbase.sqlite3")
    assert os.path.exists(db_path)
    conn = db.connect(db_path)
    row = conn.execute("SELECT value FROM config WHERE key='version'").fetchone()
    assert row[0] == "0.1.0"
```

---

### `tests/test_root.py`
```python
import os
from filer import db
from filer.commands import root


def test_root_add_and_list(tmp_path):
    db_path = tmp_path / "root.sqlite3"
    conn = db.connect(str(db_path))
    d = tmp_path / "subdir"
    d.mkdir()
    args = type("obj", (), {"db": str(db_path), "list": False, "delete": False, "classification": "high", "paths": [str(d)]})
    root.run(args)
    rows = conn.execute("SELECT path,classification FROM roots").fetchall()
    assert (str(d), "high") in rows


def test_root_delete(tmp_path):
    db_path = tmp_path / "root.sqlite3"
    conn = db.connect(str(db_path))
    d = tmp_path / "subdir"
    d.mkdir()
    conn.execute("INSERT INTO roots (path,classification) VALUES (?,?)", (str(d), "medium"))
    conn.commit()
    args = type("obj", (), {"db": str(db_path), "list": False, "delete": True, "classification": "medium", "paths": [str(d)]})
    root.run(args)
    row = conn.execute("SELECT * FROM roots").fetchone()
    assert row is None
```

---

### `tests/test_analyse.py`
```python
import os
from filer import db
from filer.commands import analyse


def test_analyse_inserts_files(tmp_path):
    db_path = tmp_path / "analyse.sqlite3"
    conn = db.connect(str(db_path))
    rootdir = tmp_path / "r1"
    rootdir.mkdir()
    f = rootdir / "f.txt"
    f.write_text("hello")
    conn.execute("INSERT INTO roots (path,classification) VALUES (?,?)", (str(rootdir), "medium"))
    conn.commit()
    args = type("obj", (), {"db": str(db_path), "all_hashes": True})
    analyse.run(args)
    row = conn.execute("SELECT name FROM files").fetchone()
    assert row[0] == "f.txt"
    sha = conn.execute("SELECT sha256 FROM sha256").fetchone()
    assert sha is not None
```

---

### `tests/test_dir.py`
```python
import os
from filer import db
from filer.commands import dir


def test_dir_set_and_list(tmp_path, capsys):
    db_path = tmp_path / "dir.sqlite3"
    conn = db.connect(str(db_path))
    d = tmp_path / "sub"
    d.mkdir()
    conn.execute("INSERT INTO directories (name,root,classification,analysed) VALUES (?,?,?,1)", ("sub",1,"medium"))
    conn.commit()
    args = type("obj", (), {"db": str(db_path), "path": str(d), "classification": "high"})
    dir.run_set(args)
    row = conn.execute("SELECT classification FROM directories WHERE name=?", ("sub",)).fetchone()
    assert row[0] == "high"


def test_dir_exclude(tmp_path):
    db_path = tmp_path / "dir.sqlite3"
    conn = db.connect(str(db_path))
    d = tmp_path / "sub"
    d.mkdir()
    conn.execute("INSERT INTO directories (name,root,classification,analysed) VALUES (?,?,?,1)", ("sub",1,"medium"))
    conn.commit()
    args = type("obj", (), {"db": str(db_path), "path": str(d)})
    dir.run_exclude(args)
    row = conn.execute("SELECT classification FROM directories WHERE name=?", ("sub",)).fetchone()
    assert row[0] == "excluded"
```

---

### `tests/test_check.py`
```python
import os
from filer import db
from filer.commands import check


def test_check_detects_missing_file(tmp_path, capsys):
    db_path = tmp_path / "check.sqlite3"
    conn = db.connect(str(db_path))
    rootdir = tmp_path / "root"
    rootdir.mkdir()
    f = rootdir / "f.txt"
    f.write_text("data")
    conn.execute("INSERT INTO roots (path,classification) VALUES (?,?)", (str(rootdir), "medium"))
    conn.execute("INSERT INTO directories (name,root,classification,analysed) VALUES (?,?,?,1)", ("root",1,"medium"))
    conn.execute("INSERT INTO files (name,ctime,mtime,atime,size,directory,mode,uid,gid,inode,dev,nlink,analysed) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,1)", ("f.txt",1,1,1,4,1,0,0,0,0,0,0,1))
    conn.commit()
    f.unlink()
    args = type("obj", (), {"db": str(db_path)})
    check.run(args)
    captured = capsys.readouterr()
    assert "File deleted" in captured.out
```

---

### `tests/test_dedup.py`
```python
import os
from filer import db
from filer.commands import dedup, analyse


def test_dedup_finds_duplicates(tmp_path, capsys):
    db_path = tmp_path / "dedup.sqlite3"
    conn = db.connect(str(db_path))
    rootdir = tmp_path / "root"
    rootdir.mkdir()
    f1 = rootdir / "a.txt"
    f2 = rootdir / "b.txt"
    f1.write_text("same")
    f2.write_text("same")
    conn.execute("INSERT INTO roots (path,classification) VALUES (?,?)", (str(rootdir), "medium"))
    conn.commit()
    args = type("obj", (), {"db": str(db_path), "all_hashes": True})
    analyse.run(args)
    args2 = type("obj", (), {"db": [str(db_path)]})
    dedup.run(args2)
    captured = capsys.readouterr()
    assert "Duplicates" in captured.out
```

---

These tests cover initialization, root handling, filesystem analysis, directory classification, integrity check, and deduplication. They use `tmp_path` for isolation and capture output where needed.
